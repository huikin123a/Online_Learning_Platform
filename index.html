<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HKDSE ICT 模擬試卷 (AI 智能版 + 歷史記錄)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Markdown Renderer -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; background-color: #f0f2f5; }
        .markdown-body { font-size: 0.95rem; line-height: 1.6; color: #374151; }
        .markdown-body strong { color: #111827; font-weight: 600; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5rem; margin: 0.5rem 0; }
        
        /* Smooth transitions */
        .btn-transition { transition: all 0.2s ease-in-out; }
        .btn-transition:active { transform: scale(0.98); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }

        @keyframes pulse-subtle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .timer-dot { animation: pulse-subtle 1s infinite; }
        
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ---------------------------------------------------------
        // API Helper
        // ---------------------------------------------------------
        const defaultApiKey = ""; 

        const callGemini = async (prompt, customKey) => {
            const apiKey = customKey || defaultApiKey;
            if (!apiKey) throw new Error("請先設定 API Key");
            
            const response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    }),
                }
            );

            if (!response.ok) throw new Error(`API Error: ${response.status}`);
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        };

        // ---------------------------------------------------------
        // 數據庫
        // ---------------------------------------------------------
        const correctAnswers = {
            1: "C", 2: "C", 3: "B", 4: "A", 5: "A", 
            6: "D", 7: "C", 8: "A", 9: "D", 10: "B",
            11: "A", 12: "A", 13: "D", 14: "B", 15: "A",
            16: "D", 17: "D", 18: "C", 19: "A", 20: "D",
            21: "D", 22: "B", 23: "B", 24: "B", 25: "B",
            26: "A", 27: "B", 28: "A", 29: "D", 30: "B",
            31: "D", 32: "A", 33: "A", 34: "C", 35: "A",
            36: "A", 37: "D", 38: "D", 39: "B", 40: "C"
        };

        const questionsData = [
            { id: 1, text: "資訊年代的出現帶來哪些改變？\n(1) 需要更多辦公室空間\n(2) 新的資訊及通訊科技相關工作出現，並改變人力市場。\n(3) 有更多機會獲得資訊和學習新事物", options: ["只有 (1) 和 (2)", "只有 (1) 和 (3)", "只有 (2) 和 (3)", "(1)、(2) 和 (3)"], year: "2017 DSE" },
            { id: 2, text: "某數據傳輸系統採用奇偶檢測。下列已接收的編碼中，其中一個是無效的。它是哪一個呢？", options: ["0101 0101", "1000 0100", "1111 0001", "0000 0011"], year: "2013 DSE" },
            { id: 3, text: "當建構網上電子郵件戶口時，需要輸入兩次密碼。重新輸入密碼的目的是什麼？", options: ["數據收集", "數據驗證 (Data Verification)", "數據組織", "數據有效性檢驗 (Data Validation)"], year: "2017 DSE" },
            { id: 4, text: "某公司設計了一個處理員工記錄的流動應用程式。每筆記錄中，以 10 個位元來儲存員工號碼和 12 個字節來儲存中文姓名。這個流動應用程式可支援多少筆員工記錄？", options: ["2^10", "2^12", "2^22", "2^96"], year: "2018 DSE" },
            { id: 5, text: "1111 1111 是一個 8 位二進制補碼數字，其十進制數值是什麼？", options: ["-1", "0", "1", "255"], year: "2016 DSE" },
            { id: 6, text: "三個純文本檔案包含一些字符...假設採用了統一碼（UTF-8）。下列哪個關於檔案大小的比較是正確的？\n(1) 2017.\n(2) JULY.\n(3) 二零一七。", options: ["(1) > (3)", "(2) > (1)", "(2) > (3)", "(3) > (2)"], year: "2017 DSE" },
            { id: 7, text: "一般而言，以下哪些轉換會明顯減少檔案大小？\n(1) ODT -> DOCX\n(2) WAV -> MP3\n(3) BMP -> JPG", options: ["只有 (1) 和 (2)", "只有 (1) 和 (3)", "只有 (2) 和 (3)", "(1)、(2) 和 (3)"], year: "New" },
            { id: 8, text: "對於一間連鎖式便利店，在下列哪項／些例子中應該使用試算表上的「假設」情境？\n(1) 改變不同參數來估算每月支出\n(2) 製作每月銷售分析\n(3) 比較不同分店的銷售數據", options: ["只有 (1)", "只有 (2)", "只有 (1) 和 (3)", "只有 (2) 和 (3)"], year: "2017 DSE" },
            { id: 9, text: "小明和小芬分享一個數據庫檔案 X，並分別執行數據庫查詢 T1 和 T2。數據庫管理系統應避免下列哪項（些）活動？\n(1) 當 T1 在讀 X 時，T2 在讀 X。\n(2) 當 T1 在 X 上寫入記錄時，T2 在 X 上寫入記錄。\n(3) 當 T1 在 X 上刪除記錄時，T2 在讀 X。", options: ["只有 (1)", "只有 (2)", "只有 (1) 和 (3)", "只有 (2) 和 (3)"], year: "2012 DSE" },
            { id: 10, text: "某數據庫設計員在數據庫管理系統內設計了一張表格，給文員輸入數據。為什麼他選擇設計此表格？", options: ["可匯入多媒體檔案。", "簡化使用者介面。", "一次可輸入更多數據。", "數據輸入花更少系統運算時間。"], year: "2013 DSE" },
            { id: 11, text: "小芬打算把她的電腦內 SATA SSD 升級至具有較高數據傳輸速率的 M.2 NVMe SSD。她應該留意下列哪項特性？", options: ["主機板設計", "CPU 運算能力", "耗電量", "儲存容量"], year: "Modified 2012" },
            { id: 12, text: "降低在桌上電腦內 CPU 的時鐘比率會有什麼可能的結果？", options: ["耗用較少電量。", "增加運算的準確度。", "增強 WiFi 連接的性能。", "加強對電腦遭黑客入侵的防護。"], year: "2019 DSE" },
            { id: 13, text: "下列哪句關於電腦內的部件的描述是不正確的？", options: ["算術及邏輯運算部件 (ALU) 是用來執行算術運算。", "累加器是儲存算術及邏輯運算結果的寄存器。", "寄存器的數據傳輸率高於主記憶體的數據傳輸率。", "數據匯流排是用於在主機板和輸入/輸出設備之間傳送控制訊號。"], year: "2020 DSE" },
            { id: 14, text: "細看下列桌上電腦的配置：\nIntel® CoreTM i7 CPU, 16GB DDR4 RAM, 1TB SSD, 802.11ac Wi-Fi\n從這些配置可獲得什麼資訊？\n(1) 顯示屏的可視尺寸\n(2) 無線網絡的最大數據傳輸速率\n(3) 啟動電腦時間", options: ["只有 (1)", "只有 (2)", "只有 (1) 和 (3)", "只有 (2) 和 (3)"], year: "2018 DSE" },
            { id: 15, text: "某訂票系統包含了多個訂票櫃位，分布在市內不同地方。顧客可在其中一個訂票櫃位購買劇院門票。下列哪項最能描述此訂票系統？", options: ["實時系統", "成批工件處理系統", "分布式處理系統", "並行式處理系統"], year: "2016 DSE" },
            { id: 16, text: "操作系統內的系統監察軟件通常會提供什麼資訊？\n(1) 現正執行處理的程序\n(2) 記憶體使用情況\n(3) 網絡流量", options: ["只有 (1) 和 (2)", "只有 (1) 和 (3)", "只有 (2) 和 (3)", "(1)、(2) 和 (3)"], year: "2017 DSE" },
            { id: 17, text: "下列哪句／些有關 IPv6 位址的語句是正確的？\n(1) 它的長度是 256 位元。\n(2) 它通常以十六進制而非十進制表示。\n(3) 可以兩個冒號取代連續的零。", options: ["只有 (1)", "只有 (2)", "只有 (1) 和 (2)", "只有 (2) 和 (3)"], year: "New" },
            { id: 18, text: "下列哪項／些是 TCP 的功能？\n(1) 分拆及重組數據。\n(2) 於數據包加入序號。\n(3) 把數據路由至目的地。", options: ["只有 (1)", "只有 (2)", "只有 (1) 和 (2)", "只有 (2) 和 (3)"], year: "New" },
            { id: 19, text: "物聯網（IoT）是指由設備組成的網絡，這些設備可收集及交換數據。這些設備應通常設有下列哪項？", options: ["IP 位址", "運算能力高的 CPU", "DNS", "大儲存容量"], year: "2016 DSE" },
            { id: 20, text: "在互聯網上，為什麼我們需要保密插口層（SSL）？", options: ["IP 位址最少包含了四個數值。", "可保護電源插口。", "數據傳輸速度可更快。", "可安全地傳輸數據。"], year: "2018 DSE" },
            { id: 21, text: "勒索軟件是惡意軟件...如何可減低受到勒索軟件的影響？\n(1) 定期建立電腦檔案備份\n(2) 不要開啟不知名的或仿冒詐騙的電子郵件\n(3) 不要透過 p2p 軟件下載盜版電腦軟件", options: ["只有 (1) 和 (2)", "只有 (1) 和 (3)", "只有 (2) 和 (3)", "(1)、(2) 和 (3)"], year: "2017 DSE" },
            { id: 22, text: "[需參考原卷圖片] 關於 www.abc.edu.hk 的資料夾結構，下列哪個 URL 是無效的？", options: ["http://www.abc.edu.hk/chi/p1.jpg", "http://www.abc.edu.hk/info/chi/p1.jpg", "http://www.abc.edu.hk/eng/p1.jpg", "http://www.abc.edu.hk/index.html"], year: "2018 DSE" },
            { id: 23, text: "技術員在辦公室網絡內安裝防火牆而非抗電腦病毒軟件，主要的理由是什麼？", options: ["保護辦公室的電腦免受廣告程式的影響。", "保護網絡免受網上保安威脅。", "在此網絡上傳送檔案可以更快。", "此網絡免受電腦病毒攻擊。"], year: "2014 DSE" },
            { id: 24, text: "下列哪項／些是使用網上銀行系統時的良好習慣？\n(1) 建立一個罕見的登入名稱。\n(2) 定期修改密碼，而該密碼是由字母及數字組成的組合。\n(3) 當有無線網絡提供時，避免使用有線網絡。", options: ["只有 (1)", "只有 (1) 和 (2)", "只有 (1) 和 (3)", "只有 (2) 和 (3)"], year: "2014 DSE" },
            { id: 25, text: "下列哪項／些關於仿冒詐騙電郵的語句是正確的？\n(1) 是某公司向目標收件人發出宣傳的廣告。\n(2) 通常透過電郵內偽冒的網站，套取個人資料。\n(3) 攻擊後，在數天內不能使用電腦。", options: ["只有 (1)", "只有 (2)", "只有 (1) 和 (3)", "只有 (2) 和 (3)"], year: "2015 DSE" },
            { id: 26, text: "小麗在解決項目中的問題時，需要準確地界定問題範圍。其主要原因是什麼？\n(1) 她能有效地把問題細分為子問題。\n(2) 她能使用真值表闡明方案。\n(3) 她能在測試算法時不理會邊際個案。", options: ["只有 (1)", "只有 (2)", "只有 (1) 和 (3)", "只有 (2) 和 (3)"], year: "2015 DSE" },
            { id: 27, text: "假設 X = 1、Y = 2 和 Z = 3。下列哪條布爾算式是「真」？", options: ["((X = 1) AND (Y > -2)) AND (Z > 3)", "((X = 1) AND (Y > -2)) OR (Z > 3)", "((X = 1) OR (Y > -2)) AND (Z > 3)", "(X = 1) AND ((Y > -2) AND (Z > 3))"], year: "2018 DSE" },
            { id: 28, text: "某保險公司要求 IT 項目經理為客戶建構一些網頁。IT 項目經理首先要做什麼？", options: ["定義服務範圍。", "評估所需的 IT 設施。", "估計項目完成日期。", "成立一項目團隊，招聘程式編寫員。"], year: "2014 DSE" },
            { id: 29, text: "空運行下列包含陣列 AR 的算法。\ncnt ← 1\nind ← 1\n當 cnt < 100\n  cnt ← cnt + 2\n  AR[ind] ← cnt\n  ind ← ind + 1\nAR[5] 的值是什麼？", options: ["1", "7", "9", "11"], year: "2012 DSE" },
            { id: 30, text: "在下列算法中，輸入什麼 B 值會產生運行錯誤？\n輸入 B\nA ← 2\nC ← 2\nD ← (B*B – 4*A*C) 的平方根\n輸出 D", options: ["-4", "2", "4", "5"], year: "2013 DSE" },
            { id: 31, text: "某陣列 DAT 儲存了英文名: [,Amy,Bob,Carol,Dave,,]。執行以下算法後，在 DAT 中哪個元素儲存「Carol」？\nP ← 4\n當 P > 2\n  DAT[P] ← DAT[P-1]\n  P ← P - 1", options: ["DAT[1]", "DAT[2]", "DAT[3]", "DAT[4]"], year: "2015 DSE" },
            { id: 32, text: "[需參考原卷 IPO 圖] 下列哪句是不正確的？", options: ["此 IPO 周期展示了數據類型及數據結構。", "所展示的問題是找出三個數值的平均數。", "此 IPO 周期展示該問題的一個解決方法。", "在「處理」內所顯示的流程圖的控制結構是序列的。"], year: "2016 DSE" },
            { id: 33, text: "A 是一個陣列，以 A[1]...A[N] 儲存 N 個非零的數值。以下算法的目的是什麼？\n輸入 P, K <- P\n當 K <= N-1 執行\n  A[K] <- A[K+1]\n  K <- K+1\nN <- N-1", options: ["移除 A 內第 P 個數值", "將 P 的值增加 1", "當 K <= N-1 時互換 A[K] 和 A[K+1] 的數值", "計算 A 內數值的總和"], year: "2017 DSE" },
            { id: 34, text: "[承上題流程圖] P[0]..P[4] 初始值為 7,7,6,7,9。i 的輸出值是什麼？", options: ["2", "3", "4", "5"], year: "2020 DSE" },
            { id: 35, text: "[承上題流程圖] n 的輸出值是什麼？", options: ["1", "2", "3", "4"], year: "2020 DSE" },
            { id: 36, text: "測試下列算法段的邊際個案是什麼？\n輸入 A\n如果 A > 5 則 B <- 10\n否則 B <- 20", options: ["只有 (1) 和 (2)", "只有 (3) 和 (4)", "只有 (2)、(3) 和 (4)", "(1)、(2)、(3) 和 (4)"], year: "2019 DSE" },
            { id: 37, text: "於設計電腦解決方案時使用模組的特徵是什麼？\n(1) 模組通常是用來解決簡單的問題。\n(2) 模組可能是可重用的。\n(3) 開發成本較高。\n(4) 模組可以獨立開發。", options: ["只有 (1) 和 (3)", "只有 (1) 和 (4)", "只有 (2) 和 (3)", "只有 (2) 和 (4)"], year: "2018 DSE" },
            { id: 38, text: "下列哪些技術可以支援人工智能 (AI) 系統？\n(1) 大數據\n(2) 雲端運算\n(3) 機器學習", options: ["只有 (1) 和 (2)", "只有 (1) 和 (3)", "只有 (2) 和 (3)", "(1)、(2) 和 (3)"], year: "New" },
            { id: 39, text: "在超級市場，透過智能手機鏡頭觀看產品時，有一個動畫顯示在手機的顯示屏幕上。需要以下哪項／些來製作此動畫？\n(1) 數據科學\n(2) 擴增實境 (AR)\n(3) 3D 打印", options: ["只有 (1)", "只有 (2)", "只有 (1) 和 (3)", "只有 (2) 和 (3)"], year: "New" },
            { id: 40, text: "下圖展示使用電腦的人體工學的良好用法...下列哪些設定是必須的？", options: ["只有 (1) 和 (2)", "只有 (1) 和 (3)", "只有 (2) 和 (3)", "(1)、(2) 和 (3)"], year: "2020 DSE" }
        ];

        // ---------------------------------------------------------
        // Component: Timer (Fixed & Stable)
        // ---------------------------------------------------------
        const Timer = ({ isRunning, onTimeUpdate }) => {
            const [seconds, setSeconds] = useState(0);

            // Ticking logic
            useEffect(() => {
                let interval;
                if (isRunning) {
                    interval = setInterval(() => {
                        setSeconds(prev => prev + 1);
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [isRunning]);

            // Sync logic - separating this avoids "Cannot update during render" warning
            useEffect(() => {
                onTimeUpdate(seconds);
            }, [seconds, onTimeUpdate]);

            const formatTime = (totalSeconds) => {
                const mins = Math.floor(totalSeconds / 60);
                const secs = totalSeconds % 60;
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            };

            return (
                <div className="flex items-center space-x-2 bg-white px-4 py-2 rounded-full shadow-sm border border-gray-200">
                    <i className={`fas fa-clock text-blue-500 ${isRunning ? 'timer-dot' : ''}`}></i>
                    <span className="font-mono text-lg font-bold text-gray-700 w-16 text-center">
                        {formatTime(seconds)}
                    </span>
                </div>
            );
        };

        // ---------------------------------------------------------
        // Component: History Modal (New)
        // ---------------------------------------------------------
        const HistoryModal = ({ history, onClose }) => {
            return (
                <div className="fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4 animate-fade-in">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden flex flex-col max-h-[80vh]">
                        <div className="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                            <h3 className="text-xl font-bold text-gray-800">
                                <i className="fas fa-history text-blue-500 mr-2"></i> 
                                練習歷史記錄
                            </h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <div className="overflow-y-auto p-0">
                            {history.length === 0 ? (
                                <div className="p-10 text-center text-gray-500">
                                    <i className="fas fa-clipboard-list text-4xl mb-3 text-gray-300"></i>
                                    <p>暫時沒有記錄，快去完成第一次練習吧！</p>
                                </div>
                            ) : (
                                <table className="w-full text-left border-collapse">
                                    <thead className="bg-gray-50 text-gray-500 text-xs uppercase sticky top-0">
                                        <tr>
                                            <th className="p-4 font-semibold">日期</th>
                                            <th className="p-4 font-semibold text-center">分數</th>
                                            <th className="p-4 font-semibold text-right">用時</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {history.map((rec, idx) => (
                                            <tr key={idx} className="hover:bg-blue-50 transition-colors">
                                                <td className="p-4 text-sm text-gray-600">
                                                    {rec.date} <br/>
                                                    <span className="text-xs text-gray-400">{rec.timeStr}</span>
                                                </td>
                                                <td className="p-4 text-center">
                                                    <span className={`inline-block px-2 py-1 rounded text-xs font-bold ${
                                                        (rec.score / rec.total) >= 0.8 ? 'bg-green-100 text-green-700' : 
                                                        (rec.score / rec.total) >= 0.5 ? 'bg-yellow-100 text-yellow-700' : 
                                                        'bg-red-100 text-red-700'
                                                    }`}>
                                                        {rec.score} / {rec.total}
                                                    </span>
                                                </td>
                                                <td className="p-4 text-right text-sm font-mono text-gray-600">
                                                    {rec.duration}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}
                        </div>
                        
                        <div className="p-4 border-t border-gray-100 bg-gray-50 text-right">
                            <button 
                                onClick={onClose}
                                className="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm text-gray-600 hover:bg-gray-100"
                            >
                                關閉
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ---------------------------------------------------------
        // Component: AI Smart Explanation
        // ---------------------------------------------------------
        const SmartExplanation = ({ question, correctAns, userApiKey, userAns }) => {
            const [explanation, setExplanation] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            const handleExplain = async () => {
                setLoading(true);
                setError(null);
                try {
                    const prompt = `
你是一位專業的香港 DSE ICT 科目導師。學生剛完成了一道多項選擇題，請為他提供「智能解題」。

**題目資料**：
* 題目：${question.text}
* 選項 A：${question.options[0]}
* 選項 B：${question.options[1]}
* 選項 C：${question.options[2]}
* 選項 D：${question.options[3]}
* 正確答案：${correctAns}
* 學生選擇：${userAns || "未作答"}

**你的任務**：
1. **概念釐清**：用簡潔易懂的語言解釋這道題目考核的核心概念。
2. **正解分析**：詳細解釋為什麼選項 ${correctAns} 是正確的。
3. **錯項分析**：逐一指出其他三個選項為什麼是錯誤的（例如：常見謬誤、概念混淆）。
4. **考試技巧**：如果有，提供一個這類題目的解題小貼士。

請使用 Markdown 格式輸出，語氣要鼓勵且專業。
`;
                    const text = await callGemini(prompt, userApiKey);
                    setExplanation(text);
                } catch (err) {
                    setError("無法連接 AI 服務。請檢查右上角的 API Key 設定是否正確。");
                    console.error(err);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="mt-6 border-t border-gray-100 pt-6">
                    <div className="flex flex-col gap-3">
                        <div className="flex items-center justify-between">
                            <h4 className="font-bold text-gray-800 flex items-center">
                                <i className="fas fa-robot text-purple-600 mr-2"></i> 
                                AI 智能導師
                            </h4>
                        </div>

                        {!explanation && !loading && (
                            <button 
                                onClick={handleExplain}
                                className="w-full sm:w-auto px-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white rounded-xl shadow-md btn-transition flex items-center justify-center gap-2 font-medium"
                            >
                                <i className="fas fa-sparkles"></i> 
                                啟動智能解題 (Smart Explanation)
                            </button>
                        )}
                        
                        {loading && (
                            <div className="flex items-center gap-3 p-4 bg-purple-50 rounded-xl border border-purple-100 text-purple-700">
                                <i className="fas fa-circle-notch fa-spin"></i>
                                <span>AI 正在分析題目概念與陷阱...</span>
                            </div>
                        )}

                        {error && (
                            <div className="p-3 bg-red-50 text-red-600 text-sm rounded-lg border border-red-100">
                                <i className="fas fa-exclamation-circle mr-1"></i> {error}
                            </div>
                        )}

                        {explanation && (
                            <div className="bg-white border border-purple-100 rounded-xl p-6 shadow-sm ring-1 ring-purple-50 animate-fade-in">
                                <div 
                                    className="markdown-body"
                                    dangerouslySetInnerHTML={{ __html: marked.parse(explanation) }}
                                />
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // ---------------------------------------------------------
        // Main App
        // ---------------------------------------------------------

        const App = () => {
            const [currentQuestionIdx, setCurrentQuestionIdx] = useState(0);
            const [userAnswers, setUserAnswers] = useState({});
            const [isSubmitted, setIsSubmitted] = useState(false);
            const [score, setScore] = useState(0);
            
            // Timer State
            const [timeElapsed, setTimeElapsed] = useState(0);
            const [finalTime, setFinalTime] = useState(0);

            // History State
            const [history, setHistory] = useState([]);
            const [showHistoryModal, setShowHistoryModal] = useState(false);

            // API Key
            const [showApiKeyModal, setShowApiKeyModal] = useState(false);
            const [userApiKey, setUserApiKey] = useState(localStorage.getItem('gemini_api_key') || '');

            const currentQuestion = questionsData[currentQuestionIdx];
            const letters = ['A', 'B', 'C', 'D'];

            // Load history from LocalStorage on mount
            useEffect(() => {
                const savedHistory = localStorage.getItem('ict_quiz_history_v2');
                if (savedHistory) {
                    try {
                        setHistory(JSON.parse(savedHistory));
                    } catch (e) {
                        console.error("Failed to parse history", e);
                    }
                }
            }, []);

            const handleOptionSelect = (optionLetter) => {
                if (isSubmitted) return;
                setUserAnswers(prev => ({
                    ...prev,
                    [currentQuestion.id]: optionLetter
                }));
            };

            const formatTime = (totalSeconds) => {
                const mins = Math.floor(totalSeconds / 60);
                const secs = totalSeconds % 60;
                return `${mins}分 ${secs}秒`;
            };

            const handleSubmit = () => {
                if (!window.confirm("確定要交卷嗎？")) return;
                
                let newScore = 0;
                questionsData.forEach(q => {
                    if (userAnswers[q.id] === correctAnswers[q.id]) {
                        newScore++;
                    }
                });
                
                setScore(newScore);
                setFinalTime(timeElapsed); // Stop timer
                setIsSubmitted(true);

                // Save to History
                const now = new Date();
                const newRecord = {
                    date: now.toLocaleDateString(),
                    timeStr: now.toLocaleTimeString(),
                    score: newScore,
                    total: questionsData.length,
                    duration: formatTime(timeElapsed)
                };
                
                const updatedHistory = [newRecord, ...history].slice(0, 10); // Keep last 10
                setHistory(updatedHistory);
                localStorage.setItem('ict_quiz_history_v2', JSON.stringify(updatedHistory));
            };

            // Scroll to top on question change
            useEffect(() => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, [currentQuestionIdx]);

            return (
                <div className="min-h-screen flex flex-col md:flex-row max-w-7xl mx-auto p-4 gap-6">
                    
                    {/* Settings Modal */}
                    {showApiKeyModal && (
                        <div className="fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4">
                            <div className="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full">
                                <h3 className="text-xl font-bold mb-2 text-gray-800">⚙️ 設定 Gemini API Key</h3>
                                <p className="text-sm text-gray-600 mb-4">
                                    為了使用 AI 智能解題，請輸入您的 Google Gemini API Key。
                                    <br/><span className="text-xs text-gray-400">您的 Key 只會儲存在瀏覽器中。</span>
                                </p>
                                <input 
                                    type="password" 
                                    className="w-full border border-gray-300 p-3 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 outline-none transition" 
                                    placeholder="在此貼上 API Key..."
                                    value={userApiKey}
                                    onChange={(e) => setUserApiKey(e.target.value)}
                                />
                                <div className="flex justify-end gap-3">
                                    <button 
                                        onClick={() => setShowApiKeyModal(false)} 
                                        className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg"
                                    >
                                        取消
                                    </button>
                                    <button 
                                        onClick={() => {
                                            localStorage.setItem('gemini_api_key', userApiKey);
                                            setShowApiKeyModal(false);
                                        }}
                                        className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm"
                                    >
                                        儲存設定
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* History Modal */}
                    {showHistoryModal && (
                        <HistoryModal history={history} onClose={() => setShowHistoryModal(false)} />
                    )}

                    {/* Left Sidebar (Navigation) */}
                    <div className="md:w-72 bg-white rounded-2xl shadow-sm border border-gray-200 p-5 flex flex-col h-[calc(100vh-2rem)] sticky top-4">
                        <div className="mb-6 flex justify-between items-start">
                            <div>
                                <h1 className="text-xl font-bold text-gray-800 tracking-tight">ICT 模擬試卷</h1>
                                <p className="text-xs text-gray-500 mt-1 font-medium">卷一 (甲部) | 全40題</p>
                            </div>
                            <button 
                                onClick={() => setShowApiKeyModal(true)} 
                                className="text-gray-400 hover:text-blue-600 transition-colors p-1" 
                                title="設定 API Key"
                            >
                                <i className="fas fa-cog text-lg"></i>
                            </button>
                        </div>
                        
                        {/* Timer Display in Sidebar */}
                        <div className="mb-6 flex justify-center">
                            <Timer isRunning={!isSubmitted} onTimeUpdate={setTimeElapsed} />
                        </div>

                        <div className="flex-grow overflow-y-auto mb-4 pr-1">
                            <div className="grid grid-cols-5 gap-2">
                                {questionsData.map((q) => {
                                    const isCurrent = currentQuestionIdx === q.id - 1;
                                    const isAnswered = userAnswers[q.id] !== undefined;
                                    let btnClass = "h-8 w-8 rounded-lg text-xs font-bold flex items-center justify-center transition-all ";
                                    
                                    if (isCurrent) {
                                        btnClass += "ring-2 ring-blue-500 ring-offset-2 bg-white border border-blue-200 text-blue-700";
                                    } else if (isAnswered) {
                                        btnClass += "bg-blue-600 text-white shadow-sm";
                                    } else {
                                        btnClass += "bg-gray-50 text-gray-400 border border-gray-100 hover:bg-gray-100";
                                    }

                                    // Submitted state styling
                                    if (isSubmitted) {
                                        const isCorrect = userAnswers[q.id] === correctAnswers[q.id];
                                        if (isCorrect) btnClass = "h-8 w-8 rounded-lg text-xs font-bold flex items-center justify-center bg-green-500 text-white shadow-sm";
                                        else btnClass = "h-8 w-8 rounded-lg text-xs font-bold flex items-center justify-center bg-red-500 text-white shadow-sm";
                                    }

                                    return (
                                        <button 
                                            key={q.id}
                                            onClick={() => setCurrentQuestionIdx(q.id - 1)}
                                            className={btnClass}
                                        >
                                            {q.id}
                                        </button>
                                    );
                                })}
                            </div>
                        </div>

                        <div className="space-y-3">
                            {!isSubmitted ? (
                                <button 
                                    onClick={handleSubmit}
                                    className="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold shadow-blue-200 shadow-lg btn-transition"
                                >
                                    提交試卷
                                </button>
                            ) : (
                                <div className="text-center bg-gray-50 p-4 rounded-xl border border-gray-200 mb-3">
                                    <p className="text-xs text-gray-500 uppercase font-bold mb-1">最終成績</p>
                                    <div className="text-3xl font-black text-gray-800 mb-1">{score} / 40</div>
                                    <div className="text-sm text-gray-600">
                                        <i className="fas fa-stopwatch mr-1"></i> {formatTime(finalTime)}
                                    </div>
                                    <button 
                                        onClick={() => window.location.reload()}
                                        className="mt-3 text-blue-600 text-sm font-semibold hover:underline"
                                    >
                                        重新開始
                                    </button>
                                </div>
                            )}

                            <button 
                                onClick={() => setShowHistoryModal(true)}
                                className="w-full border border-gray-200 text-gray-600 py-2.5 rounded-xl font-medium hover:bg-gray-50 transition-colors flex items-center justify-center gap-2 text-sm"
                            >
                                <i className="fas fa-history"></i> 查看歷史記錄
                            </button>
                        </div>
                    </div>

                    {/* Main Content (Question) */}
                    <div className="flex-1 bg-white rounded-2xl shadow-sm border border-gray-200 p-8 flex flex-col relative overflow-hidden">
                        {/* Question Header */}
                        <div className="mb-8">
                            <div className="flex items-center gap-3 mb-4">
                                <span className="px-3 py-1 bg-blue-100 text-blue-700 text-sm font-bold rounded-full">
                                    Question {currentQuestion.id}
                                </span>
                                {currentQuestion.year && (
                                    <span className="px-3 py-1 bg-gray-100 text-gray-600 text-sm rounded-full">
                                        {currentQuestion.year}
                                    </span>
                                )}
                            </div>
                            <h2 className="text-xl md:text-2xl font-medium text-gray-800 leading-relaxed whitespace-pre-line">
                                {currentQuestion.text}
                            </h2>
                        </div>

                        {/* Options */}
                        <div className="space-y-3 mb-8">
                            {currentQuestion.options.map((opt, idx) => {
                                const letter = letters[idx];
                                const isSelected = userAnswers[currentQuestion.id] === letter;
                                const isCorrect = correctAnswers[currentQuestion.id] === letter;
                                
                                let cardClass = "relative p-4 rounded-xl border-2 cursor-pointer transition-all flex items-start gap-4 ";
                                
                                if (!isSubmitted) {
                                    if (isSelected) cardClass += "border-blue-500 bg-blue-50 shadow-md";
                                    else cardClass += "border-gray-100 bg-white hover:border-blue-200 hover:bg-gray-50";
                                } else {
                                    if (isCorrect) cardClass += "border-green-500 bg-green-50 shadow-sm"; // Always show correct answer
                                    else if (isSelected && !isCorrect) cardClass += "border-red-500 bg-red-50 shadow-sm opacity-100"; // Wrong selection
                                    else cardClass += "border-gray-100 opacity-50"; // Irrelevant options
                                }

                                return (
                                    <div key={idx} onClick={() => handleOptionSelect(letter)} className={cardClass}>
                                        <div className={`
                                            w-8 h-8 flex-shrink-0 rounded-full flex items-center justify-center font-bold text-sm
                                            ${!isSubmitted && isSelected ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-500'}
                                            ${isSubmitted && isCorrect ? '!bg-green-500 !text-white' : ''}
                                            ${isSubmitted && isSelected && !isCorrect ? '!bg-red-500 !text-white' : ''}
                                        `}>
                                            {letter}
                                        </div>
                                        <div className="text-gray-700 pt-1 font-medium">{opt}</div>
                                        
                                        {isSubmitted && (
                                            <div className="ml-auto">
                                                {isCorrect && <i className="fas fa-check-circle text-green-500 text-xl"></i>}
                                                {isSelected && !isCorrect && <i className="fas fa-times-circle text-red-500 text-xl"></i>}
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>

                        {/* AI Section (Only visible after submit) */}
                        {isSubmitted && (
                            <SmartExplanation 
                                question={currentQuestion}
                                correctAns={correctAnswers[currentQuestion.id]}
                                userAns={userAnswers[currentQuestion.id]}
                                userApiKey={userApiKey}
                            />
                        )}

                        {/* Navigation Buttons */}
                        <div className="mt-auto flex justify-between pt-8 border-t border-gray-100">
                            <button 
                                onClick={() => setCurrentQuestionIdx(Math.max(0, currentQuestionIdx - 1))}
                                disabled={currentQuestionIdx === 0}
                                className="flex items-center gap-2 px-5 py-2.5 text-gray-600 hover:bg-gray-100 rounded-lg disabled:opacity-30 disabled:hover:bg-transparent transition-colors font-medium"
                            >
                                <i className="fas fa-arrow-left"></i> 上一題
                            </button>
                            <button 
                                onClick={() => setCurrentQuestionIdx(Math.min(questionsData.length - 1, currentQuestionIdx + 1))}
                                disabled={currentQuestionIdx === questionsData.length - 1}
                                className="flex items-center gap-2 px-6 py-2.5 bg-gray-800 text-white rounded-lg hover:bg-gray-700 disabled:opacity-30 transition-all shadow-md font-medium"
                            >
                                下一題 <i className="fas fa-arrow-right"></i>
                            </button>
                        </div>

                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>